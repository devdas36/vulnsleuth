<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Scan - VulnSleuth</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body data-theme="{{ theme }}">
    {% include 'partials/navbar.html' %}
    
    <div class="container">
        {% include 'partials/sidebar.html' %}
        
        <main class="main-content">
            <div class="page-header">
                <div>
                    <h1><i class="fas fa-crosshairs"></i> New Security Scan</h1>
                    <p>Configure and launch a vulnerability scan</p>
                </div>
            </div>
            
            <div class="scan-container">
                <div class="scan-form-card card">
                    <h3><i class="fas fa-cogs"></i> Scan Configuration</h3>
                    
                    <form id="scanForm">
                        <div class="form-group">
                            <label for="target">
                                <i class="fas fa-bullseye"></i> Target
                            </label>
                            <input type="text" id="target" name="target" required 
                                   placeholder="Enter IP address, domain, or URL (e.g., 192.168.1.1, example.com, http://example.com)">
                            <small>Enter a valid IP address, domain name, or URL to scan</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="scanType">
                                <i class="fas fa-tasks"></i> Scan Type
                            </label>
                            <select id="scanType" name="scanType" required>
                                <option value="full">Full Scan (All Checks)</option>
                                <option value="network">Network Scan</option>
                                <option value="webapp">Web Application Scan</option>
                                <option value="local">Local Security Check</option>
                                <option value="quick">Quick Scan</option>
                                <option value="custom">Custom Scan</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="threads">
                                    <i class="fas fa-microchip"></i> Threads
                                </label>
                                <input type="number" id="threads" name="threads" value="10" min="1" max="20">
                                <small>Number of concurrent threads</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="timeout">
                                    <i class="fas fa-clock"></i> Timeout (seconds)
                                </label>
                                <input type="number" id="timeout" name="timeout" value="300" min="60" max="3600">
                                <small>Maximum scan duration</small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="aggressive" name="aggressive">
                                <span><i class="fas fa-fire"></i> Aggressive Mode</span>
                                <small>Enable more intensive scanning (may be detectable)</small>
                            </label>
                        </div>
                        
                        <div class="form-group" id="pluginSelection">
                            <label>
                                <i class="fas fa-plug"></i> Select Plugins
                            </label>
                            <div class="plugin-grid">
                                {% for plugin in plugins %}
                                <label class="plugin-checkbox">
                                    <input type="checkbox" name="plugins" value="{{ plugin.name }}" 
                                           {% if plugin.enabled %}checked{% endif %}>
                                    <div class="plugin-card-mini">
                                        <i class="fas fa-puzzle-piece"></i>
                                        <span>{% if 'Authentication' in plugin.name %}Auth Bypass{% elif 'CVE' in plugin.name %}CVE Intel{% elif 'Database' in plugin.name %}DB Security{% elif 'Information' in plugin.name %}Info Disclosure{% elif 'Network' in plugin.name %}Network Recon{% elif 'SSL' in plugin.name %}SSL/TLS Audit{% elif 'Web' in plugin.name %}Web Scanner{% else %}{{ plugin.name }}{% endif %}</span>
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-play"></i> Start Scan
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="scan-info-card card">
                    <h3><i class="fas fa-info-circle"></i> Scan Information</h3>
                    <div class="info-list">
                        <div class="info-item">
                            <i class="fas fa-shield-alt"></i>
                            <div>
                                <h4>Security Notice</h4>
                                <p>Only scan systems you own or have permission to test</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-clock"></i>
                            <div>
                                <h4>Scan Duration</h4>
                                <p>Typical scans take 5-30 minutes depending on configuration</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-chart-line"></i>
                            <div>
                                <h4>Real-time Results</h4>
                                <p>View scan progress and results in real-time</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-download"></i>
                            <div>
                                <h4>Export Reports</h4>
                                <p>Generate detailed reports in multiple formats</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Active Scans -->
            <div class="card" id="activeScansCard" style="display: none;">
                <div class="card-header">
                    <h3><i class="fas fa-sync fa-spin"></i> Active Scans</h3>
                </div>
                <div id="activeScansList"></div>
            </div>
        </main>
    </div>
    
    <!-- Scan Progress Modal -->
    <div id="scanProgressModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-sync fa-spin"></i> Scan in Progress</h3>
            </div>
            <div class="modal-body">
                <div class="scan-progress-info">
                    <p><strong>Target:</strong> <span id="scanTargetName"></span></p>
                    <p><strong>Status:</strong> <span id="scanStatusText">Running...</span></p>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="scanProgressBar" style="width: 0%"></div>
                </div>
                <p class="progress-text"><span id="scanProgressText">0</span>% Complete</p>
                <div id="scanLiveResults" class="live-results"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeScanModal()">Run in Background</button>
                <button class="btn btn-primary" onclick="viewResults()" id="viewResultsBtn" style="display: none;">View Results</button>
            </div>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        let currentScanId = null;
        let scanInterval = null;
        
        document.getElementById('scanForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const target = document.getElementById('target').value;
            const scanType = document.getElementById('scanType').value;
            const threads = parseInt(document.getElementById('threads').value);
            const timeout = parseInt(document.getElementById('timeout').value);
            const aggressive = document.getElementById('aggressive').checked;
            
            // Get selected plugins
            const plugins = Array.from(document.querySelectorAll('input[name="plugins"]:checked'))
                .map(cb => cb.value);
            
            try {
                showNotification('Starting scan...', 'info');
                
                const response = await fetch('/api/scan/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        target,
                        scan_type: scanType,
                        threads,
                        timeout,
                        aggressive,
                        plugins
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentScanId = data.scan_id;
                    showNotification('Scan started successfully!', 'success');
                    openScanModal(target);
                    startScanMonitoring(data.scan_id);
                } else {
                    showNotification(data.message || 'Failed to start scan', 'error');
                }
            } catch (error) {
                showNotification('Failed to start scan: ' + error.message, 'error');
            }
        });
        
        function openScanModal(target) {
            document.getElementById('scanTargetName').textContent = target;
            document.getElementById('scanProgressBar').style.width = '0%';
            document.getElementById('scanProgressText').textContent = '0';
            document.getElementById('scanStatusText').textContent = 'Running...';
            document.getElementById('viewResultsBtn').style.display = 'none';
            document.getElementById('scanProgressModal').style.display = 'flex';
        }
        
        function closeScanModal() {
            document.getElementById('scanProgressModal').style.display = 'none';
            if (scanInterval) {
                clearInterval(scanInterval);
            }
        }
        
        function startScanMonitoring(scanId) {
            scanInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/scan/status/${scanId}`);
                    const data = await response.json();
                    
                    if (data.status === 'completed') {
                        document.getElementById('scanProgressBar').style.width = '100%';
                        document.getElementById('scanProgressText').textContent = '100';
                        document.getElementById('scanStatusText').textContent = 'Completed!';
                        document.getElementById('viewResultsBtn').style.display = 'block';
                        clearInterval(scanInterval);
                        showNotification('Scan completed successfully!', 'success');
                    } else if (data.status === 'failed') {
                        document.getElementById('scanStatusText').textContent = 'Failed: ' + (data.error || 'Unknown error');
                        clearInterval(scanInterval);
                        showNotification('Scan failed', 'error');
                    } else if (data.status === 'running') {
                        const progress = data.progress || 0;
                        document.getElementById('scanProgressBar').style.width = progress + '%';
                        document.getElementById('scanProgressText').textContent = Math.round(progress);
                    }
                } catch (error) {
                    console.error('Failed to check scan status:', error);
                }
            }, 2000);
        }
        
        function viewResults() {
            window.location.href = '/reports?scan_id=' + currentScanId;
        }
        
        function resetForm() {
            document.getElementById('scanForm').reset();
        }
        
        // Update plugin selection based on scan type
        document.getElementById('scanType').addEventListener('change', (e) => {
            const scanType = e.target.value;
            const pluginSelection = document.getElementById('pluginSelection');
            
            if (scanType === 'custom') {
                pluginSelection.style.display = 'block';
            } else {
                pluginSelection.style.display = 'none';
            }
        });
        
        // Initialize
        document.getElementById('pluginSelection').style.display = 'none';
    </script>
</body>
</html>
