<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - VulnSleuth</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body data-theme="{{ theme }}">
    {% include 'partials/navbar.html' %}
    
    <div class="container">
        {% include 'partials/sidebar.html' %}
        
        <main class="main-content">
            <div class="page-header">
                <div>
                    <h1><i class="fas fa-cog"></i> Settings</h1>
                    <p>Customize your VulnSleuth experience</p>
                </div>
            </div>
            
            <div class="settings-container">
                <!-- Theme Settings -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-palette"></i> Appearance</h3>
                    </div>
                    <div class="settings-section">
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Theme</h4>
                                <p>Choose your preferred color theme</p>
                            </div>
                            <div class="setting-control">
                                <div class="theme-selector">
                                    <div class="theme-option" onclick="changeTheme('light')" data-theme="light">
                                        <div class="theme-preview theme-light">
                                            <i class="fas fa-sun"></i>
                                        </div>
                                        <span>Light</span>
                                    </div>
                                    <div class="theme-option" onclick="changeTheme('dark')" data-theme="dark">
                                        <div class="theme-preview theme-dark">
                                            <i class="fas fa-moon"></i>
                                        </div>
                                        <span>Dark</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Account Settings -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-user"></i> Account</h3>
                    </div>
                    <div class="settings-section">
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Username</h4>
                                <p>{{ user.username }}</p>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Email</h4>
                                <p>{{ user.email }}</p>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Member Since</h4>
                                <p>{{ user.created_at }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Security Settings -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-shield-alt"></i> Security</h3>
                    </div>
                    <div class="settings-section">
                        <form id="passwordForm">
                            <div class="form-group">
                                <label for="current_password">
                                    <i class="fas fa-lock"></i> Current Password
                                </label>
                                <input type="password" id="current_password" name="current_password" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="new_password">
                                    <i class="fas fa-lock"></i> New Password
                                </label>
                                <input type="password" id="new_password" name="new_password" required>
                                <small>Minimum 8 characters</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="confirm_password">
                                    <i class="fas fa-lock"></i> Confirm New Password
                                </label>
                                <input type="password" id="confirm_password" name="confirm_password" required>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Update Password
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- About -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-info-circle"></i> About</h3>
                    </div>
                    <div class="settings-section">
                        <div class="about-content">
                            <div class="about-logo">
                                <i class="fas fa-shield-alt"></i>
                                <h2>VulnSleuth</h2>
                            </div>
                            <p>Advanced Vulnerability Scanner & Security Assessment Tool</p>
                            <div class="about-links">
                                <a href="https://github.com/devdas36" target="_blank">
                                    <i class="fab fa-github"></i> GitHub
                                </a>
                                <a href="mailto:d3vdas36@gmail.com">
                                    <i class="fas fa-envelope"></i> Contact
                                </a>
                            </div>
                            <p class="text-muted">Author: Devdas</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // Highlight current theme
        document.addEventListener('DOMContentLoaded', () => {
            const currentTheme = '{{ theme }}';
            const themeOption = document.querySelector(`.theme-option[data-theme="${currentTheme}"]`);
            if (themeOption) {
                themeOption.classList.add('active');
            }
        });
        
        async function changeTheme(theme) {
            try {
                const response = await fetch('/api/settings/theme', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ theme })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Theme updated successfully', 'success');
                    document.body.setAttribute('data-theme', theme);
                    
                    // Update active state
                    document.querySelectorAll('.theme-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    document.querySelector(`.theme-option[data-theme="${theme}"]`).classList.add('active');
                } else {
                    showNotification(data.message || 'Failed to update theme', 'error');
                }
            } catch (error) {
                showNotification('Failed to update theme: ' + error.message, 'error');
            }
        }
        
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current_password').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                showNotification('New passwords do not match', 'error');
                return;
            }
            
            // Validate password length
            if (newPassword.length < 8) {
                showNotification('Password must be at least 8 characters', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/settings/password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Password updated successfully', 'success');
                    document.getElementById('passwordForm').reset();
                } else {
                    showNotification(data.message || 'Failed to update password', 'error');
                }
            } catch (error) {
                showNotification('Failed to update password: ' + error.message, 'error');
            }
        });
    </script>
</body>
</html>
